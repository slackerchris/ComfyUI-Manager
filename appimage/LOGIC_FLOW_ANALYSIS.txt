================================================================================
LOGIC FLOW ANALYSIS - v2.4.1
================================================================================

SCENARIO 1: Fresh Launch (ComfyUI not running)
---------------------------------------------
1. AppImage mounts â†’ AppRun â†’ Qt Manager starts
2. __init__() creates ComfyUIManager
   - self.comfyui_process = None âœ“
   - setup_ui() creates buttons âœ“
   - setup_monitoring() starts ProcessMonitor thread âœ“
3. ProcessMonitor.get_comfyui_status() runs every 1 second
   - Scans for: 'main.py' in cmdline AND 'comfyui_qt_manager.py' not in cmdline âœ“
   - Manager's process: '/tmp/.mount_XXX/comfyui_qt_manager.py' â†’ EXCLUDED âœ“
   - ComfyUI not running â†’ count=0, running=False âœ“
4. update_process_info() receives: {'running': False, 'count': 0}
   - Sets status "ğŸ”´ Not Running" âœ“
5. update_ui_state() 
   - running=False â†’ Start enabled, Stop disabled âœ“

RESULT: âœ… Should show correct state

SCENARIO 2: Click "Start ComfyUI"
----------------------------------
1. start_comfyui() called
2. Check if already running: self.process_info.get('running', False) â†’ False âœ“
3. Check if process exists: self.comfyui_process is None â†’ proceed âœ“
4. Build command: python3 main.py --listen 127.0.0.1 --port 8188 âœ“
5. Set environment: PYTHONHOME, PYTHONPATH (with stdlib) âœ“
6. Popen with DEVNULL âœ“
7. Store: self.comfyui_process = <Popen object> âœ“
8. Schedule: check_startup_success() in 2 seconds âœ“
9. ProcessMonitor detects new process on next cycle
   - Finds: python3 /path/app/main.py â†’ MATCHES âœ“
   - count=1, running=True âœ“
10. UI updates to "ğŸŸ¢ Running" âœ“

RESULT: âœ… Should work

SCENARIO 3: Click "Stop ComfyUI"  
---------------------------------
1. stop_comfyui() called
2. find_comfyui_processes() finds running ComfyUI âœ“
3. psutil.Process(pid).terminate() âœ“
4. self.comfyui_process = None  âœ“ (FIXED!)
5. ProcessMonitor detects process gone on next cycle
   - count=0, running=False âœ“
6. UI updates to "ğŸ”´ Not Running" âœ“

RESULT: âœ… Should work

SCENARIO 4: Click "Restart ComfyUI" (when running)
---------------------------------------------------
1. restart_comfyui() called
2. Set self._restarting = True âœ“
3. Call stop_comfyui()
   - Finds process, terminates it âœ“
   - Checks self._restarting â†’ True, NO BLOCKING DIALOG âœ“ (FIXED!)
   - Sets self.comfyui_process = None âœ“
4. QTimer.singleShot(2000, start_after_stop) âœ“
5. After 2 seconds:
   - start_after_stop() sets self._restarting = False âœ“
   - Calls self.start_comfyui() âœ“
   - ComfyUI launches âœ“

RESULT: âœ… Should work

SCENARIO 5: Click "Restart ComfyUI" (when NOT running)
-------------------------------------------------------
1. restart_comfyui() called
2. Set self._restarting = True âœ“
3. Call stop_comfyui()
   - find_comfyui_processes() returns [] âœ“
   - Checks self._restarting â†’ True, NO BLOCKING DIALOG âœ“ (FIXED!)
   - Logs warning, returns early âœ“
4. QTimer still schedules start_after_stop() âœ“
5. After 2 seconds:
   - start_after_stop() sets self._restarting = False âœ“
   - Calls self.start_comfyui() âœ“
   - ComfyUI launches âœ“

RESULT: âœ… Should work (just starts it)

================================================================================
EDGE CASES TO CHECK
================================================================================

Edge Case 1: Start button spammed
----------------------------------
- First click: starts process, sets self.comfyui_process
- Second click (before detection): 
  - Line 569: self.comfyui_process.poll() is None â†’ True (still running)
  - Logs warning, returns âœ“
RESULT: âœ… Protected

Edge Case 2: Stop when process already dead
--------------------------------------------
- find_comfyui_processes() returns []
- Logs warning âœ“
- Shows dialog (if not restarting) âœ“
- No crash âœ“
RESULT: âœ… Handled

Edge Case 3: Crash during subprocess.Popen
-------------------------------------------
- Exception caught in start_comfyui() âœ“
- Error logged and shown to user âœ“
- self.comfyui_process remains None âœ“
RESULT: âœ… Handled

Edge Case 4: Process dies immediately after start
--------------------------------------------------
- check_startup_success() runs after 2 seconds
- poll() returns exit code (not None)
- Logs failure âœ“
- Sets self.comfyui_process = None âœ“
- ProcessMonitor sees no process âœ“
RESULT: âœ… Handled

================================================================================
REMAINING ISSUES TO FIX
================================================================================

ISSUE 1: Version number still says v2.4.0
- Should be updated to v2.4.1
- Locations: Lines 459, 534, 544, ~927

ISSUE 2: Inconsistency check
- Need to verify app.setApplicationVersion() matches tooltips

================================================================================
VERDICT
================================================================================

Logic Flow: âœ… CORRECT (after our fixes)
Edge Cases: âœ… HANDLED  
Version: âŒ NEEDS UPDATE to v2.4.1

Confidence: HIGH - The logic should work correctly now with both fixes:
1. Process detection excludes manager âœ“
2. Restart doesn't show blocking dialog âœ“
3. Stop cleans up process reference âœ“

================================================================================
